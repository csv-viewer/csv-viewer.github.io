<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">

  <!-- ===== PWA / MANIFEST (optional but kept for theme) ===== -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb" id="theme-color-meta">

  <!-- ===== SEO META - FULLY OPTIMIZED ===== -->
  <title>Online CSV Viewer & Editor ‚Äì Free XLSX Editor, Convert to Excel PDF</title>
  <meta name="description"
    content="Free online CSV and XLSX viewer & editor. Open, edit and convert Excel files to CSV or PDF. 100% client-side, private & secure. No upload, no install." />
  <meta name="keywords"
    content="csv viewer online, xlsx viewer, edit xlsx online free, csv to excel, excel to csv, csv editor, open xlsx online, merged cells support" />
  <meta name="robots" content="index, follow" />
  <meta name="author" content="Online CSV Editor" />
  <meta name="google-site-verification" content="VSBl5weWwGZHXeyDEJx5MeZS1WBwyP_zfAzooD0S8Tc" />
  <link rel="canonical" href="https://csv-viewer.github.io/" />

  <!-- ===== OPEN GRAPH ===== -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Free Online CSV & XLSX Editor ‚Äì Edit Excel Files in Browser" />
  <meta property="og:description"
    content="Edit CSV and XLSX files online. No installation, no upload. Merged cells support, export to Excel, PDF, CSV." />
  <meta property="og:url" content="https://csv-viewer.github.io/" />
  <meta property="og:image" content="https://csv-viewer.github.io/assets/csv-editor-preview.png" />
  <meta property="og:site_name" content="Online CSV Editor" />

  <!-- ===== TWITTER ===== -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Free Online CSV & XLSX Editor" />
  <meta name="twitter:description"
    content="Edit Excel files directly in browser. No install, private, supports merged cells." />
  <meta name="twitter:image" content="https://csv-viewer.github.io/assets/csv-editor-preview.png" />

  <!-- ===== MOBILE WEB APP (no install prompt) ===== -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- ===== STRUCTURED DATA - RICH SNIPPET ===== -->
  <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Online CSV & XLSX Editor",
  "description": "Free online spreadsheet editor for CSV and XLSX files. Edit, convert to Excel or PDF. 100% client-side.",
  "applicationCategory": "BusinessApplication",
  "operatingSystem": "All",
  "browserRequirements": "JavaScript enabled",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  },
  "featureList": [
    "CSV editing",
    "XLSX viewing and editing",
    "Merged cells support",
    "Export to XLSX",
    "Export to PDF",
    "Dark mode"
  ]
}
</script>

  <!-- ===== JSZIP + SHEETJS FOR FULL XLSX SUPPORT ===== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>

  <style>
    /* ----- LIGHT THEME (default) ----- */
    :root {
      --bg: #f8fafd;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #475569;
      --accent: #0f7832;
      --accent2: #2563eb;
      --th-bg: #f1f5f9;
      --table-header: #0a4b2e;
      --cell-border: #cbd5e1;
      --hover-row: rgba(37, 99, 235, 0.04);
      --shadow: 0 8px 24px rgba(0,0,0,0.05);
      --upload-dash: #2563eb;
      --btn-bg: #f1f5f9;
      --btn-text: #1e293b;
      --btn-hover: #e2e8f0;
      --toggle-bg: #e2e8f0;
      --guide-bg: #f1f5f9;
      --icon-stroke: #1e293b;
    }

    /* ----- DARK THEME ----- */
    :root[data-theme="dark"] {
      --bg: #0a0c10;
      --card: #161b22;
      --border: #2d333b;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #4ade80;
      --accent2: #388bfd;
      --th-bg: #1c2128;
      --table-header: #8bffa4;
      --cell-border: #3d444d;
      --hover-row: rgba(56, 139, 253, 0.1);
      --shadow: 0 8px 24px rgba(0,0,0,0.4);
      --upload-dash: #388bfd;
      --btn-bg: #2d333b;
      --btn-text: #e6edf3;
      --btn-hover: #3d444d;
      --toggle-bg: #2d333b;
      --guide-bg: #1c2128;
      --icon-stroke: #e6edf3;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.2s, color 0.2s;
      padding: 16px;
    }

    .icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      stroke: var(--icon-stroke);
      fill: none;
      stroke-width: 1.8;
      stroke-linecap: round;
      stroke-linejoin: round;
      vertical-align: middle;
    }

    .icon-sm { width: 18px; height: 18px; }
    .icon-lg { width: 24px; height: 24px; }

    .container {
      width: 100%;
      max-width: 1400px;
    }

    .card {
      background: var(--card);
      border-radius: 20px;
      padding: 28px 24px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: background 0.2s, border 0.2s;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      gap: 16px 24px;
      margin-bottom: 20px;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .csv-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(145deg, #22c55e, #15803d);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      color: white;
      box-shadow: 0 4px 10px rgba(34,197,94,0.2);
    }

    .title {
      font-size: 1.6rem;
      font-weight: 700;
      margin: 0;
      line-height: 1.2;
      letter-spacing: -0.01em;
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .theme-toggle {
      display: flex;
      background: var(--toggle-bg);
      border-radius: 10px;
      padding: 4px;
      border: 1px solid var(--border);
    }

    .theme-btn {
      background: transparent;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: 0.1s;
    }

    .theme-btn.active {
      background: var(--card);
      border: 1px solid var(--border);
    }

    .onboarding-guide {
      background: var(--guide-bg);
      border-left: 5px solid var(--accent2);
      border-radius: 12px;
      padding: 14px 20px;
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      border: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .guide-steps {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .step-indicator {
      background: var(--accent2);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .dismiss-guide {
      background: transparent;
      border: 1px solid var(--border);
      padding: 6px 14px;
      border-radius: 6px;
      color: var(--muted);
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .upload {
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 24px 20px;
      text-align: center;
      cursor: pointer;
      transition: 0.2s;
      border-color: var(--upload-dash);
      background: var(--card);
      margin-bottom: 16px;
    }

    .upload:hover {
      background: var(--hover-row);
      border-color: var(--accent2);
    }

    .upload span {
      color: var(--accent2);
      font-weight: 600;
    }

    .controls {
      display: none;
      gap: 10px;
      flex-wrap: wrap;
      margin: 16px 0 16px;
    }

    .controls input,
    .controls button {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--btn-bg);
      color: var(--btn-text);
      font-size: 0.85rem;
      font-weight: 500;
    }

    .controls input {
      background: var(--card);
      flex: 1 1 200px;
    }

    .controls button {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: 0.15s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .controls button:hover {
      background: var(--btn-hover);
      border-color: var(--accent2);
    }

    .table-wrap {
      max-height: 460px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: var(--th-bg);
      z-index: 10;
    }

    th {
      padding: 10px 8px;
      color: var(--table-header);
      font-weight: 700;
      border: 1px solid var(--cell-border);
      white-space: nowrap;
      background: var(--th-bg);
    }

    td {
      padding: 8px 6px;
      border: 1px solid var(--cell-border);
      white-space: nowrap;
      cursor: text;
      background: var(--card);
      color: var(--text);
    }

    td[colspan], td[rowspan] {
      background: var(--card);
    }

    td:focus {
      outline: 2px solid var(--accent2);
      outline-offset: -2px;
    }

    tbody tr:hover td {
      background: var(--hover-row);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    @media (max-width: 640px) {
      body { padding: 8px; }
      .card { padding: 20px 12px; }
      .title { font-size: 1.3rem; }
      .onboarding-guide { padding: 12px; }
      .guide-steps { gap: 12px; }
      .step { width: 100%; }
      .controls button { padding: 8px 12px; }
    }

    #feedbackToast {
      visibility: hidden;
      min-width: 240px;
      background: var(--accent2);
      color: white;
      text-align: center;
      border-radius: 10px;
      padding: 12px 20px;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      z-index: 999;
      transition: visibility 0.2s, opacity 0.2s;
      opacity: 0;
    }
    #feedbackToast.show {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      
      <div class="header">
        <div class="brand">
          <div class="csv-icon">CSV</div>
          <div>
            <h1 class="title">CSV & XLSX Editor</h1>
            <p class="subtitle">Edit ¬∑ Merged cells ¬∑ Export XLSX ¬∑ Dark mode</p>
          </div>
        </div>
        
        <div class="theme-toggle" id="themeToggleGroup">
          <button id="themeLightBtn" class="theme-btn" title="Light theme">
            <svg class="icon" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="5" />
              <line x1="12" y1="1" x2="12" y2="3" />
              <line x1="12" y1="21" x2="12" y2="23" />
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
              <line x1="1" y1="12" x2="3" y2="12" />
              <line x1="21" y1="12" x2="23" y2="12" />
            </svg>
            Light
          </button>
          <button id="themeDarkBtn" class="theme-btn" title="Dark theme">
            <svg class="icon" viewBox="0 0 24 24">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
            </svg>
            Dark
          </button>
        </div>
      </div>

      <div class="onboarding-guide" id="onboardingGuide">
        <div class="guide-steps">
          <div class="step">
            <span class="step-indicator">1</span>
            <span>üìÅ Drop or click to load CSV/XLSX</span>
          </div>
          <div class="step">
            <span class="step-indicator">2</span>
            <span>‚úèÔ∏è Double-click cells to edit</span>
          </div>
          <div class="step">
            <span class="step-indicator">3</span>
            <span>‚¨áÔ∏è Export to XLSX/CSV/PDF</span>
          </div>
        </div>
        <button id="dismissGuideBtn" class="dismiss-guide">
          <svg class="icon icon-sm" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
          Dismiss
        </button>
      </div>

      <div class="upload" id="uploadBox">
        <svg class="icon icon-lg" viewBox="0 0 24 24" style="margin-bottom: 6px;">
          <rect x="2" y="3" width="20" height="18" rx="2" ry="2" />
          <line x1="12" y1="6" x2="12" y2="12" />
        </svg>
        <div>Drop <span>.csv, .xlsx</span> or <span>click to browse</span></div>
        <div style="font-size: 0.75rem; margin-top: 6px; color: var(--muted);">Supports merged cells, formatting preserved</div>
      </div>
      <input type="file" id="fileInput" accept=".csv,.xlsx" hidden>

      <div class="controls" id="controls">
        <input type="text" id="search" placeholder="Search across rows...">
        <button onclick="exportCSV()">
          <svg class="icon" viewBox="0 0 24 24">
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>
          CSV
        </button>
        <button onclick="exportXLSX()" style="background: var(--accent2); color: white; border-color: var(--accent2);">
          <svg class="icon" viewBox="0 0 24 24" style="stroke: white;">
            <rect x="4" y="2" width="16" height="20" rx="2" ry="2" />
            <line x1="8" y1="8" x2="16" y2="8" />
            <line x1="8" y1="12" x2="16" y2="12" />
            <line x1="8" y1="16" x2="12" y2="16" />
          </svg>
          XLSX
        </button>
        <button onclick="exportPDF()">
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
          </svg>
          PDF
        </button>
      </div>

      <div class="table-wrap" id="tableWrap">
        <div class="empty-state">
          <svg class="icon" viewBox="0 0 24 24" width="40" height="40">
            <rect x="2" y="4" width="20" height="16" rx="2" ry="2" />
          </svg>
          <p><strong>No file loaded</strong><br><span style="color: var(--muted);">Click or drag XLSX/CSV to start ‚Äî merged cells supported</span></p>
        </div>
      </div>

    </div>
  </div>

  <div id="feedbackToast">‚ú® Ready</div>

  <script>
    // ========== PROFESSIONAL XLSX EDITOR ==========
    // Supports merged cells, proper XLSX export/import, no install button
    
    // ----- THEME -----
    const root = document.documentElement;
    const metaThemeColor = document.getElementById('theme-color-meta');
    const lightBtn = document.getElementById('themeLightBtn');
    const darkBtn = document.getElementById('themeDarkBtn');

    function setTheme(theme, save = true) {
      if (theme === 'dark') {
        root.setAttribute('data-theme', 'dark');
        metaThemeColor.setAttribute('content', '#0a0c10');
        darkBtn.classList.add('active');
        lightBtn.classList.remove('active');
      } else {
        root.setAttribute('data-theme', 'light');
        metaThemeColor.setAttribute('content', '#2563eb');
        lightBtn.classList.add('active');
        darkBtn.classList.remove('active');
      }
      if (save) localStorage.setItem('csv-theme', theme);
    }

    const saved = localStorage.getItem('csv-theme');
    if (saved) setTheme(saved, false);
    else setTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light', false);

    lightBtn.onclick = () => setTheme('light');
    darkBtn.onclick = () => setTheme('dark');

    // ----- ONBOARDING -----
    const guide = document.getElementById('onboardingGuide');
    if (localStorage.getItem('guideDismissed') === 'true') guide.style.display = 'none';
    
    document.getElementById('dismissGuideBtn').onclick = () => {
      guide.style.display = 'none';
      localStorage.setItem('guideDismissed', 'true');
    };

    // ----- TOAST -----
    const toast = document.getElementById('feedbackToast');
    function showToast(msg, duration = 2000) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    // ----- CORE VARIABLES -----
    const fileInput = document.getElementById('fileInput');
    const uploadBox = document.getElementById('uploadBox');
    const tableWrap = document.getElementById('tableWrap');
    const searchInput = document.getElementById('search');
    const controls = document.getElementById('controls');
    let tableData = [];
    let currentFilter = '';
    let currentMergedCells = []; // Store merged cell info for rendering

    // ----- LOAD XLSX WITH SHEETJS (preserves merged cells) -----
    async function loadXLSX(arrayBuffer) {
      try {
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        // Extract merged cells
        currentMergedCells = worksheet['!merges'] || [];
        
        // Convert to array of arrays
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
          header: 1, 
          defval: '',
          blankrows: true 
        });
        
        // Filter out completely empty rows
        tableData = jsonData.filter(row => row && row.length > 0 && row.some(cell => cell !== ''));
        
        // Ensure all rows have same length
        const maxCols = Math.max(...tableData.map(row => row.length));
        tableData = tableData.map(row => {
          const newRow = [...row];
          while (newRow.length < maxCols) newRow.push('');
          return newRow;
        });
        
        renderTable(tableData, currentMergedCells);
        controls.style.display = 'flex';
        showToast('‚úÖ XLSX loaded with merged cells preserved');
      } catch (err) {
        console.error(err);
        showToast('‚ùå Failed to load XLSX', 3000);
      }
    }

    // ----- LOAD CSV -----
    function loadCSV(text) {
      tableData = text.trim().split(/\r?\n/).map(r => 
        r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim())
      );
      currentMergedCells = []; // No merged cells in CSV
      renderTable(tableData);
      controls.style.display = 'flex';
      showToast('‚úÖ CSV loaded');
    }

    // ----- RENDER WITH MERGED CELL SUPPORT -----
    function renderTable(data, mergedCells = []) {
      if (!data || data.length === 0) {
        tableWrap.innerHTML = '<div class="empty-state"><svg class="icon" viewBox="0 0 24 24" width="40" height="40"><rect x="2" y="4" width="20" height="16" rx="2" ry="2"/></svg><p><strong>No data</strong></p></div>';
        return;
      }

      // Apply filter
      let displayData = data;
      if (currentFilter) {
        displayData = [data[0], ...data.slice(1).filter(r => 
          r.join(' ').toLowerCase().includes(currentFilter)
        )];
      }

      // Build HTML with merged cells
      let html = '<table><thead><tr>';
      
      // Header row
      for (let i = 0; i < displayData[0].length; i++) {
        html += `<th>${escapeHTML(displayData[0][i] || '')}</th>`;
      }
      html += '</tr></thead><tbody>';
      
      // Create a matrix to track which cells are already rendered (for merged cells)
      const rendered = Array(displayData.length).fill().map(() => Array(displayData[0].length).fill(false));
      
      for (let i = 1; i < displayData.length; i++) {
        html += '<tr>';
        for (let j = 0; j < displayData[0].length; j++) {
          if (rendered[i][j]) continue;
          
          let colspan = 1;
          let rowspan = 1;
          let value = displayData[i]?.[j] !== undefined ? displayData[i][j] : '';
          
          // Check if this cell is part of a merge
          for (let merge of mergedCells) {
            if (merge.s.r === i-1 && merge.s.c === j) { // Adjust for header row
              colspan = merge.e.c - merge.s.c + 1;
              rowspan = merge.e.r - merge.s.r + 1;
              
              // Mark all spanned cells as rendered
              for (let r = 0; r < rowspan; r++) {
                for (let c = 0; c < colspan; c++) {
                  if (i + r < displayData.length && j + c < displayData[0].length) {
                    rendered[i + r][j + c] = true;
                  }
                }
              }
              break;
            }
          }
          
          // If not merged, mark this cell as rendered
          if (colspan === 1 && rowspan === 1) {
            rendered[i][j] = true;
          }
          
          html += `<td contenteditable 
                    oninput="updateCell(${i}, ${j}, this.innerText)"
                    ${colspan > 1 ? `colspan="${colspan}"` : ''}
                    ${rowspan > 1 ? `rowspan="${rowspan}"` : ''}>${escapeHTML(value)}</td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      
      tableWrap.innerHTML = html;
    }

    // ----- UPDATE CELL -----
    window.updateCell = function(rowIdx, colIdx, val) {
      if (!tableData[rowIdx]) tableData[rowIdx] = [];
      tableData[rowIdx][colIdx] = val;
    };

    // ----- ESCAPE HTML -----
    function escapeHTML(s) {
      if (s === undefined || s === null) return '';
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // ----- SEARCH (debounced) -----
    let searchTimer;
    searchInput.oninput = () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        currentFilter = searchInput.value.toLowerCase();
        if (tableData.length) renderTable(tableData, currentMergedCells);
      }, 200);
    };

    // ----- EXPORT TO XLSX (proper format) -----
    window.exportXLSX = function() {
      if (!tableData.length) return showToast('‚ùå No data to export', 1500);
      
      try {
        // Create worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(tableData);
        
        // Add merged cells if any
        if (currentMergedCells && currentMergedCells.length > 0) {
          ws['!merges'] = currentMergedCells;
        }
        
        // Add to workbook
        XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
        
        // Export
        XLSX.writeFile(wb, 'edited.xlsx');
        showToast('‚¨áÔ∏è XLSX exported with merged cells');
      } catch (err) {
        console.error(err);
        showToast('‚ùå Export failed', 1500);
      }
    };

    // ----- EXPORT CSV -----
    window.exportCSV = function() {
      if (!tableData.length) return showToast('‚ùå No data to export', 1500);
      
      try {
        const ws = XLSX.utils.aoa_to_sheet(tableData);
        const csv = XLSX.utils.sheet_to_csv(ws);
        download(csv, 'edited.csv', 'text/csv');
        showToast('‚¨áÔ∏è CSV exported');
      } catch (err) {
        // Fallback
        const csv = tableData.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
        download(csv, 'edited.csv', 'text/csv');
        showToast('‚¨áÔ∏è CSV exported');
      }
    };

    // ----- EXPORT PDF -----
    window.exportPDF = function() {
      if (!tableData.length) return showToast('‚ùå No data to export', 1500);
      
      const w = window.open('');
      w.document.write(`<html><head><style>
        table { border-collapse: collapse; width: 100%; font-size: 10px; }
        td, th { border: 1px solid #000; padding: 4px; }
        @page { size: A4 landscape; margin: 8mm; }
        body { background: #fff; color: #000; font-family: system-ui; }
      </style></head><body>${tableWrap.innerHTML}</body></html>`);
      w.document.close();
      setTimeout(() => { 
        w.print(); 
        w.close(); 
        showToast('üìÑ PDF ready'); 
      }, 300);
    };

    // ----- DOWNLOAD HELPER -----
    function download(data, name, mime) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([data], { type: mime }));
      a.download = name;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 100);
    }

    // ----- FILE LOADING -----
    async function loadFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      
      try {
        if (ext === 'xlsx') {
          showToast('üìä Reading XLSX...', 1000);
          const buffer = await file.arrayBuffer();
          await loadXLSX(buffer);
        } else if (ext === 'csv') {
          const text = await file.text();
          loadCSV(text);
        } else {
          showToast('‚ùå Please use .csv or .xlsx files', 3000);
        }
      } catch (err) {
        console.error(err);
        showToast('‚ùå Error loading file', 2000);
      }
    }

    // ----- EVENT LISTENERS -----
    uploadBox.onclick = () => fileInput.click();
    fileInput.onchange = e => e.target.files[0] && loadFile(e.target.files[0]);

    uploadBox.ondragover = e => { e.preventDefault(); uploadBox.style.borderColor = 'var(--accent2)'; };
    uploadBox.ondragleave = () => uploadBox.style.borderColor = 'var(--upload-dash)';
    uploadBox.ondrop = e => {
      e.preventDefault();
      uploadBox.style.borderColor = 'var(--upload-dash)';
      if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
    };

    // First edit hint
    document.addEventListener('input', e => {
      if (e.target.matches('td[contenteditable]') && !window.editHintShown) {
        showToast('‚úèÔ∏è Cell updated');
        window.editHintShown = true;
      }
    }, { once: true });

    // Expose functions globally
    window.exportXLSX = window.exportXLSX;
    window.exportCSV = window.exportCSV;
    window.exportPDF = window.exportPDF;
  </script>
</body>

</html>
