const root=document.documentElement,metaThemeColor=document.getElementById("theme-color-meta"),lightBtn=document.getElementById("themeLightBtn"),darkBtn=document.getElementById("themeDarkBtn");function setTheme(e,t=!0){"dark"===e?(root.setAttribute("data-theme","dark"),metaThemeColor.setAttribute("content","#0a0c10"),darkBtn.classList.add("active"),lightBtn.classList.remove("active")):(root.setAttribute("data-theme","light"),metaThemeColor.setAttribute("content","#2563eb"),lightBtn.classList.add("active"),darkBtn.classList.remove("active")),t&&localStorage.setItem("csv-theme",e)}const saved=localStorage.getItem("csv-theme");saved?setTheme(saved,!1):setTheme(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",!1),lightBtn.onclick=()=>setTheme("light"),darkBtn.onclick=()=>setTheme("dark");const guide=document.getElementById("onboardingGuide");"true"===localStorage.getItem("guideDismissed")&&(guide.style.display="none"),document.getElementById("dismissGuideBtn").onclick=()=>{guide.style.display="none",localStorage.setItem("guideDismissed","true")};const toast=document.getElementById("feedbackToast");function showToast(e,t=2e3){toast.textContent=e,toast.classList.add("show"),setTimeout(()=>toast.classList.remove("show"),t)}const fileInput=document.getElementById("fileInput"),uploadBox=document.getElementById("uploadBox"),tableWrap=document.getElementById("tableWrap"),searchInput=document.getElementById("search"),controls=document.getElementById("controls");let tableData=[],currentFilter="";async function parseXLSX(e){try{let t=await JSZip.loadAsync(e),a=[],l=t.file(/xl\/sharedStrings\.xml/);if(l.length){let o=await l[0].async("text"),r=o.match(/<t[^>]*>([^<]+)<\/t>/g);r&&(a=r.map(e=>e.replace(/<\/?t[^>]*>/g,"")))}let n=t.file(/xl\/worksheets\/sheet\d+\.xml/);if(!n.length)throw Error("No sheets found");let s=await n[0].async("text"),d=[],i=s.match(/<row[^>]*>.*?<\/row>/g)||[];for(let c of i){let h=[],p=c.match(/<c[^>]*>(.*?)<\/c>/g)||[];for(let m of p){let u="";if(m.includes('t="s"')){let g=m.match(/<v>([^<]+)<\/v>/);if(g&&g[1]){let f=parseInt(g[1]);u=a[f]||""}}else{let $=m.match(/<v>([^<]+)<\/v>/);$&&(u=$[1])}h.push(u)}h.length>0&&d.push(h)}return d.length>0?d:[["Empty XLSX file"]]}catch(b){throw console.error("XLSX parse error:",b),b}}async function loadFile(e){let t=e.name.split(".").pop().toLowerCase();try{if("xlsx"===t){showToast("\uD83D\uDCCA Reading XLSX...",1e3);let a=await e.arrayBuffer();tableData=await parseXLSX(a),renderTable(tableData),controls.style.display="flex",showToast("✅ XLSX loaded successfully")}else if("csv"===t){let l=await e.text();tableData=l.trim().split(/\r?\n/).map(e=>e.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(e=>e.replace(/^"|"$/g,"").trim())),renderTable(tableData),controls.style.display="flex",showToast("✅ CSV loaded")}else"xls"===t?showToast("⚠️ Old .xls not supported, save as .xlsx or .csv",3e3):showToast("❌ Unsupported format",2e3)}catch(o){console.error(o),showToast("❌ Error loading file",2e3)}}function renderTable(e){if(!e||0===e.length){tableWrap.innerHTML='<div class="empty-state"><svg class="icon" viewBox="0 0 24 24" width="40" height="40"><rect x="2" y="4" width="20" height="16" rx="2" ry="2"/></svg><p><strong>No data</strong></p></div>';return}let t=e;currentFilter&&(t=[e[0],...e.slice(1).filter(e=>e.join(" ").toLowerCase().includes(currentFilter))]);let a="<table><thead><tr>";for(let l of(0===t[0].length&&(t[0]=["Column 1","Column 2"]),t[0]))a+=`<th>${escapeHTML(l||"")}</th>`;a+="</tr></thead><tbody>";for(let o=1;o<t.length;o++){a+="<tr>";for(let r=0;r<t[0].length;r++){let n=t[o]?.[r]!==void 0?t[o][r]:"";a+=`<td contenteditable oninput="updateCell(${o}, ${r}, this.innerText)">${escapeHTML(n)}</td>`}a+="</tr>"}a+="</tbody></table>",tableWrap.innerHTML=a}function escapeHTML(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}window.updateCell=function(e,t,a){tableData[e]||(tableData[e]=[]),tableData[e][t]=a};let searchTimer;function download(e,t,a){let l=document.createElement("a");l.href=URL.createObjectURL(new Blob([e],{type:a})),l.download=t,l.click(),setTimeout(()=>URL.revokeObjectURL(l.href),100)}searchInput.oninput=()=>{clearTimeout(searchTimer),searchTimer=setTimeout(()=>{currentFilter=searchInput.value.toLowerCase(),tableData.length&&renderTable(tableData)},200)},window.exportCSV=function(){if(!tableData.length)return showToast("❌ No data to export",1500);let e=tableData.map(e=>e.map(e=>`"${String(e).replace(/"/g,'""')}"`).join(",")).join("\n");download(e,"edited.csv","text/csv"),showToast("⬇️ CSV exported")},window.exportExcel=function(){if(!tableData.length)return showToast("❌ No data to export",1500);let e=`<table>${tableData.map(e=>"<tr>"+e.map(e=>`<td>${e}</td>`).join("")+"</tr>").join("")}</table>`;download(e,"edited.xls","application/vnd.ms-excel"),showToast("⬇️ XLS exported")},window.exportPDF=function(){if(!tableData.length)return showToast("❌ No data to export",1500);let e=window.open("");e.document.write(`<html><head><style>
        table{border-collapse:collapse;width:100%;}
        td,th{border:1px solid #000;padding:4px;}
        @page{size:A4 landscape;margin:8mm;}
      </style></head><body>${tableWrap.innerHTML}</body></html>`),e.document.close(),setTimeout(()=>{e.print(),e.close(),showToast("\uD83D\uDCC4 PDF ready")},300)},uploadBox.onclick=()=>fileInput.click(),fileInput.onchange=e=>e.target.files[0]&&loadFile(e.target.files[0]),uploadBox.ondragover=e=>{e.preventDefault(),uploadBox.style.borderColor="var(--accent2)"},uploadBox.ondragleave=()=>uploadBox.style.borderColor="var(--upload-dash)",uploadBox.ondrop=e=>{e.preventDefault(),uploadBox.style.borderColor="var(--upload-dash)",e.dataTransfer.files[0]&&loadFile(e.dataTransfer.files[0])},document.addEventListener("input",e=>{e.target.matches("td[contenteditable]")&&!window.editHintShown&&(showToast("✏️ Cell updated"),window.editHintShown=!0)},{once:!0}),"serviceWorker"in navigator&&navigator.serviceWorker.register("service-worker.js").catch(()=>{});let deferredPrompt;window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e,document.getElementById("installBtn").hidden=!1}),document.getElementById("installBtn").onclick=async()=>{deferredPrompt.prompt(),await deferredPrompt.userChoice,deferredPrompt=null,document.getElementById("installBtn").hidden=!0};
